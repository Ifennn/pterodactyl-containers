#!/bin/bash

## 
# Pterodactyl Backup Script
#
# This script runs a backup to the current directory.
# Intended to work alongside another backup system (rsnapshot, borgbackup, etc...)
##

set -euf -o pipefail

exec > >(trap "" INT TERM; awk '{ print strftime("[%m/%d/%y %H:%M:%S]"), $0 }')
exec 2> >(trap "" INT TERM; awk '{ print strftime("[%m/%d/%y %H:%M:%S]"), $0 }' >&2)

workDir="$(pwd)"

cd "$(dirname $0)/../"

# Check if panel exists, if not, exit.
if ! [[ "$(docker-compose config --services)" =~ "panel" ]]; then
    printf "Docker Compose service \"panel\" does not exist! There is no backup to perform..."
    exit
fi

printf "## Starting Pterodactyl Database Dump ##\n"

printf "Backing up Database\n"
docker-compose run \
    --rm -v "${workDir}":/backup \
    --entrypoint /bin/sh \
    panel -c "
        mysqldump --user=\${DB_USERNAME} --password=\"\${DB_PASSWORD}\" --host=\${DB_HOST} --port=\${DB_PORT} --databases \${DB_DATABASE} > /backup/db-dump.sql" 

printf "## Application Dump Complete ##\n\n"

printf "!! Warning, this application only has exported the database configuration for pterodactyl.\n"
printf "Please make sure that the database and configuration of the panel and daemon are backed up separately.\n"
sleep 0.5
